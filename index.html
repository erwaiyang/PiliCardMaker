<!DOCTYPE html>
<html>
<head>
	<title>霹靂群雄戰之自己動手做卡片</title>
	<meta property="og:title" content="霹靂群雄戰之自己動手做卡片 | 想要的人物自己做" />
	<meta property="og:description" content="上傳圖片、修改人物參數自己合成卡片" />
	<meta property="og:type" content="game" />
	<meta property="og:image" content="./img/piliheros.jpg" />
	<meta property="og:site_name" content="霹靂群雄戰之自己動手做卡片"/>
	<meta http-equiv="content-type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<!--CDN-->	
	<link href="http://netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css" rel="stylesheet" />
	<style>
		#hidden_area {display:none;}
		.information {margin-bottom:5px;}
		.modal-body {font-size:20px;}
		li{margin-bottom:7px;}
	</style>
</head>
<body>
	<div class="container-fluid">
		<div class="row-fluid">
			<div class="col-lg-1">
			</div>
			<!--中間-->
			<div class="col-lg-10">
				<div class="row-fluid">
					<div class="col-lg-12">
						<div class="page-header">
							<h1>霹靂群雄戰之<strong>自己動手做卡片</strong> <small>V0.9 字型[<a href="#" id="fontMode_input">手動輸入</a>|<a href="#" id="fontMode_auto">自動載入</a>]</small>	</h1>
						</div>
					</div>
				</div>
				
				<div class="row-fluid">
					<!--畫布-->
					<div class="col-lg-4">
						<center>
							<canvas id="c" width="300" height="425" style="border:1px solid #000000"></canvas>
						</center>
						<hr />
						<div id="bg_img_select"></div>
					</div>
					<!--按鈕區-->
					<div class="col-lg-1 text-center">
						<button type="button" class="information btn btn-default btn-lg" title="作者資訊" id="aboutAuthor" data-placement="right"  data-toggle="modal" data-target="#aboutAuhtor_modal">
							<span class="glyphicon glyphicon-info-sign"></span>
						</button>
						<button type="button" class="information btn btn-default btn-lg" title="使用說明" id="mustRead" data-placement="right" data-toggle="modal" data-target="#mustRead_modal">
							<span class="glyphicon glyphicon-question-sign"></span>
						</button>
							<hr />
						<button type="button" class="information btn btn-default btn-lg" title="確定放置預覽圖片" id="moveOK">
							<span class="glyphicon glyphicon-ok"></span>
						</button>
						<button type="button" class="information btn btn-default btn-lg" title="移除圖片" id="removePic">
							<span class="glyphicon glyphicon-remove"></span>
						</button>
						<button type="button" class="information btn btn-default btn-lg" title="重新選中圖片" id="selectAgain">
							<span class="glyphicon glyphicon-pencil"></span>
						</button>
						<button type="button" class="information btn btn-default btn-lg" title="清除資料 全部重設" id="resetForm">
							<span class="glyphicon glyphicon-repeat"></span>
						</button>
					</div>
					<!--控制區-->
					<div class="col-lg-7">
						<div class="alert alert-danger" id="alertBox">
							<button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
							<p>FireFox有嚴重BUG，<em>不推薦使用</em></p>
							<p>CHROME是目前相容性最好的瀏覽器</p>
							<p>IE11測試OK</p>
							<hr />
							<p><h4>必須使用有安裝<strong>FLASH</strong>的電腦/平板/手機，否則無法載入字型！</h4></p>
						</div>
						<table class="table table-bordered table-hover text-center">
							<tr>
								<td>角色名稱</td>
								<td>
									<input type="text" placeholder="1~5個字" id="input_name" />
									<br />
									<span id="fontMode_input">
										(字型：<input type="text" placeholder="您電腦上有的字型" id="input_name_fontfamily" /><button type="button" class="btn  btn-default btn-sm" id="change_name_font">更改</button>)
									</span>
									<span id="fontMode_auto">
										(字型：<span id="fontList">字型載入中</span>)
									</span>
								</td>
							</tr>
							<tr>
								<td>勢力範圍</td>
								<td id="p1">
									<button id="p1_hs" value="hs">人</button>
									<button id="p1_st" value="st">異</button>
									<button id="p1_de" value="de">魔</button>
									<button id="p1_sa" value="sa">聖</button>
								</td>
							</tr>
							<tr>
								<td>性格屬性</td>
								<td id="p2">
									<button id="p2_smart" value="smart">智</button>
									<button id="p2_kind" value="kind">仁</button>
									<button id="p2_brave" value="brave">勇</button>
									<button id="p2_mad" value="mad">狂</button></td>
							</tr>
							<tr>
								<td>星等</td>
								<td id="stars">
									<button id="star1" value="1">1</button>
									<button id="star2" value="2">2</button>
									<button id="star3" value="3">3</button>
									<button id="star4" value="4">4</button>
									<button id="star5" value="5">5</button>
									<button id="star6" value="6">6</button>
								</td>
							</tr>
							<tr>
								<td>COST</td>
								<td>
									<input type="number" id="input_cost" />
									<br />
								</td>
							</tr>
							<tr>
								<td>命</td>
								<td><input type="number" id="input_hp" /></td>
							</tr>
							<tr>
								<td>武</td>
								<td><input type="number" id="input_mp" /></td>
							</tr>
							<tr>
								<td>角色圖片</td>
								<td><input type="file" id="filePhoto" accept="image/*" /></td>
							</tr>
							<tr>
								<td colspan="2">
									<button class="btn btn-success" id="create">生成卡片！</button>
									<hr />
									<span id="download_link"></span>
								</td>
							</tr>
						</table>
					</div>

				</div>
			</div>
			<div class="col-lg-1" id="hidden_area">
				<img id="preload" />
			</div>
		</div>
	</div>
	
<!--視窗-->
<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="aboutAuhtor_modal" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title">關於作者</h4>
			</div>
			<div class="modal-body">
				<p>我是作者<a href="https://www.facebook.com/profile.php?id=100001510010637">二歪楊</a>，我的遊戲ID也是這個</p>
				<p>熱愛霹靂布袋戲所以才很喜歡這款遊戲，雖然他的改版不佳、太慢，但還是死守著繼續發掘樂趣(笑)</p>
				<p>沒有使用過的道友們記得看一下<strong>使用說明</strong>，希望這支小程式也能為大家帶來樂趣、彌補很多人物沒出的遺憾(霹靂人物真的太多了XD)</p>
				<p>有任何指教、回報BUG也可以<a href="mailto:bdlas321@gmail.com">寄信給我</a></p>
				<p>本程式發布在<a href="https://www.facebook.com/groups/445368542230566/">《霹靂群雄戰》英雄募集公開亭</a></p>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">關閉</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade bs-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" id="mustRead_modal" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
				<h4 class="modal-title">使用說明</h4>
			</div>
			<div class="modal-body">
				<ol><h3><strong>使用步驟</strong> <a href="./manual.html">[圖文版]</a> </h3>
					<li>填上角色的各種資料</li>
					<li>選角色的兩種屬性、星等(目前只有5.6星-金色邊框)</li>
					<li>載入角色圖片，一開始會是半透明狀，主要先調好位置、大小</li>
					<li>調整好位置、大小後按下旁邊的打勾按鈕，圖片變回正常透明度，還是能拖曳進行調整</li>
					<li>確定完成之後，按下綠色的生成按鈕，在產生的連結上另存新檔(不建議打開)</li>
				</ol>
				<hr />
				<ul>
					<li>
						<ol><strong>關於圖片去背</strong>
							<li><strong>不一定</strong>要去背，只是去背後會更像正版卡片XD</li>
							<li>	圖片去背是個有難度的工作，並非電腦簡單的演算就可以完全去背，常用的軟體像是Photoshop，<a href="http://pixlr.com/editor/" target="_blank">pixlr</a>這個線上網站有很多類似PS的功能，也可以去背
							</li>
							<li>背景透明的人物圖片，請記得存成PNG檔，才能保留圖片的透明資訊(JPG格式不能保留透明訊息)</li>
						</ol>
					</li>
					<li>
						<ol><strong>關於名字的字型</strong>
							<li>目前找到最接近原版字型的是「華康行楷體」
							</li>
							<li>如果您的瀏覽器不支援或是您的電腦裡沒有安裝此款字型，跑出來的就會是微軟正黑體(推薦使用FireFox)
							</li>
						</ol>
					</li>
					<li>
						<ol><strong>下面的三個按鈕</strong>
							<li>
							第一個是確認放置。圖片第一次被匯入到編輯區時，是半透明狀態，用於大範圍調整。待調整完畢之後就可以按下了，圖片會變回一般正常的不透明狀。
							</li>
							<li>
							第二個是移除編輯區的圖片。這個程式一次只能有一張人物圖片在編輯區。
							</li>
							<li>
							第三個是重新選取圖片。當按下確認放置時，因為外掛程式的小麻煩&BUG，有十點到旁邊會沒辦法再從編輯區中選中圖片，因此有這個按鈕可以重新選中人物圖片。
							</li>
						</ol>
					</li>
					<li>
						<ul><strong>生成圖片</strong>
							<li>如果直接點擊連結，部分瀏覽器可能會打不開，或是跑得很慢，所以盡量用右鍵儲存(這是HTML5&JAVASCRIPT客戶端技術，所有工作都是在您的瀏覽器上完成，跟伺服器無關，所以絕對無毒請放心XD)
							</li>
						</ul>
					</li>
				</ul>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-default" data-dismiss="modal">關閉</button>
			</div>
		</div>
	</div>
</div>

	
	<!-- CDN -->
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
	<script type="text/javascript" src="http://netdna.bootstrapcdn.com/bootstrap/3.1.0/js/bootstrap.min.js"></script>
	
	<script type="text/javascript" src="./js/fabric.js-1.4.4/dist/fabric.min.js"></script>
	<script>
	/****************公用區****************/
	//背景圖片
	var bg_imgs = ['green','blue','pinkpurple'];
	//(DOM)畫布上的物件
	
(function($){
	//統一刪除
	$.fn.removeThoseOnCanvas = function(condition){
		
		if(condition==false){
			this.each(function(e, val){
				//0.1是邊框跟命武的漸層
				if(e>1)
					this.remove();
			});
		}else{
			this.each(function(e, val){
				if(this.top==condition){
					this.remove();
				}
			});
		}
		
		canvas.renderAll();
		return true;
	};
	
	$.setNumbers = function(hpORmp,set_top,set_left){
		var leng = hpORmp.length;
		for(var d=leng-1; d>=0; d--){
			fabric.Image.fromURL(
			'./img/util/number/'+hpORmp[d]+'.png',
			function(output_hp){
				canvas.add(output_hp);
			},
			{
				left:set_left+d*17,
				top:set_top,
				width:20,
				height:20,
				selectable:false
			}
		);
			
		}
	};
	
})(jQuery);
	
	/****************畫布設定****************/
		var canvas = new fabric.Canvas('c');

		//設定背景
		canvas.setBackgroundImage('./img/bg/green.jpg', canvas.renderAll.bind(canvas));
		
		var role_border = null;
		var role_border_type = 'gold';
		//邊框顏色
		fabric.Image.fromURL(
			'./img/border/gold.png', 
			function(o){
				canvas.add(o);
				role_border = o;
			},
			{
				selectable:false
			});
		
		//漸層
		fabric.Image.fromURL(
			'./img/util/gradient_hp_mp.png', 
			function(o){
				canvas.add(o);
				o.sendBackwards(true);
			},
			{
				top:339,
				left:90,
				opacity:1,
				selectable:false
			});
			
	/****************控制區****************/
		//名字輸入
		var role_name = null;
		$('#input_name').change(function(e){
			canvas.remove(role_name);
		
			var name = $(this).val();
			var vertical_name = '';
			var leng = name.length;
			for(var a=0;a<leng;a++){
				vertical_name += name[a];
				if(a!=leng){
					vertical_name += '\n';
				}
			}
			//根據字數計算TOP的位置
			var offset = (leng -3)*(-18); //以3個字為基準
			
			role_name = new fabric.Text(
				vertical_name,
				{
					opacity:0.9,
					left:16,
					top:90+offset,
					fontSize:30,
					fontFamily:'DFXingKai Std, 華康行楷體, 微軟正黑體, 標楷體',
					selectable:false
				}
			); 
			
			canvas.add(role_name).renderAll();
		});
		
		//更改勢力範圍
		var role_p1 = null;
		$('td#p1 button').click(function(e){
			canvas.remove(role_p1);
			var img_url = './img/p1/'+role_border_type+'/'+$(this).val()+'.png';
			
			fabric.Image.fromURL(
				img_url,
				function(output){
					canvas.add(output);
					role_p1 = output;
				},
				{
					left:0,
					top:0,
					width:70,
					height:66.5,
					selectable:false
				}
			); 
			
		});
		
		//更改性格
		var role_p2 = null;
		$('td#p2 button').click(function(e){
			canvas.remove(role_p2);
			var img_url2 = './img/p2/'+role_border_type+'/'+$(this).val()+'.png';
			
			fabric.Image.fromURL(
				img_url2,
				function(output2){
					canvas.add(output2);
					role_p2 = output2;
				},
				{
					left:256,
					top:2,
					width:43,
					height:43,
					selectable:false
				}
			); 
			
		});
		
		//更改COST
		var role_cost = null;
		$('#input_cost').change(function(e){
			canvas.remove(role_cost);
			
			var cost = $(this).val();
			
				var offset = 0; //以2位數為基準
				if(cost<10){
					offset = 7;
				}
			
			role_cost = new fabric.Text(
				cost,
				{
					opacity:0.95,
					left:7+offset,
					top:395,
					fontSize:24,
					fill:'rgb(255,255,255)',
					fontFamily:'Autumn, 微軟正黑體',
					selectable:false
				}
			); 
			
			canvas.add(role_cost).renderAll();
		});
		
		//更改HP
		$('#input_hp').change(function(e){
			var hp_top = 348, hp_left=190;
			$(window.canvas._objects).removeThoseOnCanvas(hp_top);
			var role_hp = $(this).val();
			$.setNumbers(role_hp,hp_top,hp_left);
			
			canvas.renderAll();
		});
		
		//更改MP
		$('#input_mp').change(function(e){
			var mp_top = 378, mp_left = 168;
			$(window.canvas._objects).removeThoseOnCanvas(mp_top);
			var role_mp = $(this).val();
			$.setNumbers(role_mp,mp_top,mp_left);
			
			canvas.renderAll();
		});
		
		//更改星等
		$('td#stars button').click(function(e){
			var role_star = $(this).val();
			$(window.canvas._objects).removeThoseOnCanvas(30);
			for(var b=0;b<role_star;b++){
				fabric.Image.fromURL(
					'./img/util/star.png',
					function(output){
						canvas.add(output);
					},
					{
						left:75+(b*29),
						top:30,
						width:23,
						height:25,
						selectable:false
					}
				); 
			}
			//改邊框
			var card_name = "";
			switch(role_star){
				case"1":
				case"2":
					card_name = "normal";
				break;
				case"3":
				case"4":
					card_name = "silver";
				break;
				case"5":
				case"6":
					card_name = "gold";
				break;
			}
			
			if(card_name!=role_border_type){
				canvas.remove(role_border);				
				fabric.Image.fromURL(
					"./img/border/"+card_name+".png",
					function(output){
						canvas.add(output);
						role_border = output;
					},
					{
						selectable:false
					}
				); 
				role_border_type = card_name;
			}
		
		});
		
		//更改背景
		var insert_bg_imgs = '';
		for(var c=0; c<bg_imgs.length; c++){
			insert_bg_imgs+='<a href="#" class="bg_imgs_change"><img src="./img/bg/'+bg_imgs[c]+'.jpg" width="50px" height="50px" /></a> ';
		}
		$('div#bg_img_select').html(insert_bg_imgs);
		
		$('.bg_imgs_change').on('click',function(){
			canvas.setBackgroundImage($(this).children('img').attr('src'), canvas.renderAll.bind(canvas));
		});
		
		//角色圖片
		var role_img = null;
		function readURL(input) {
			if (input.files && input.files[0]) {
				var reader = new FileReader();
				var image  = new Image();
				
				reader.onload = function(e) {
					image.src    = e.target.result; 
					image.onload = function() {
						var w = this.width,h = this.height,t = input.type;
				
						var options = {opacity:0.6,top:0,left:0};
						if( w > 600){
							options.width = 400;
							var p = (400/w);
							options.height = h*p;
							console.log('p='+p+' '+options.width+' '+options.height);
						}
						//把圖片載入到畫布中
						fabric.Image.fromURL(e.target.result, function(oImg) {
							canvas.add(oImg);
							role_img = oImg;
							oImg.set({
								borderColor: 'red',
								cornerColor: 'green',
								cornerSize: 10,
								cornerSize: 15,
								transparentCorners: false
							});
							canvas.setActiveObject(oImg);
							//this.__canvas.push(canvas);
			
						},options);
					};
					image.onerror= function() {
						alert('Invalid file type: '+ input.type);
					};
				}
				reader.readAsDataURL(input.files[0]);
			}
		}
			$("#filePhoto").change(function() {
				canvas.remove(role_img);
				readURL(this);
			});
		

		
		//生成圖片
		$('button#create').click(function(){
			canvas.deactivateAll().renderAll();
			var c=document.getElementById("c");
			var url = c.toDataURL('image/jpeg');
			$('#download_link').html('[<a href="'+url+'" target="_blank">下載圖片(請按右鍵另存)</a>]');
			//var export_img = canvas.toDataURL("image/jpeg");
			//window.open(test,'卡片',config='height=600,width=600');
		});
		
		
		$('button.btn-lg').tooltip();
		
		//按鈕專區
			//確定放置
			$('button#moveOK').click(function(){
				role_img.sendToBack().setOpacity(1);
				canvas.renderAll();
			});
			//移除圖片
			$('button#removePic').click(function(){
				canvas.remove(role_img).renderAll();
				$('input#filePhoto').val('');
			});
			//重新選中圖片
			$('button#selectAgain').click(function(){
				canvas.setActiveObject(role_img);
			});
			//重設表單
			$('button#resetForm').click(function(){
				canvas.remove(role_img);
				$("input").val('');
				$(window.canvas._objects).removeThoseOnCanvas(false);
			});
	
	/****************更新****************/
	//調整字型
	$('#change_name_font').click(function(e){
		if($('input#input_name').val()!=''){
			role_name.setFontFamily($('input#input_name_fontfamily').val());
			canvas.renderAll();
		}
	});
	/*
	$('#change_cost_font').click(function(e){
		if($('#input_cost').val()!=''){
			role_cost.setFontFamily($('#input_cost_fontfamily').val());
			canvas.renderAll();
		}
	});
	*/
	$('a#fontMode_input').click(function(){
		$('span#fontMode_input').show();
		$('span#fontMode_auto').add('#alertBox').hide();
	});
	$('a#fontMode_auto').click(function(){
		$('span#fontMode_input').hide();
		$('span#fontMode_auto').add('#alertBox').show();
	});
	$('a#fontMode_input').trigger('click');
	
	function populateFontList(fontArr)
	{
		var allFontsCounter = 0;
		var regularFontsCounter = 0;
		var totalFonts = '<select>';
		
		for (var key in fontArr)
		{
			var fontName = fontArr[key];
			// trim
			fontName = fontName.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
			
			if (fontName.match(/[_\-\s]Italic$/)
				|| fontName.match(/[_\-\s](Demi)?[Bb]old$/)
				|| fontName.match(/[_\-\s]Medium$/)
				|| fontName.match(/[_\-\s](Ultra)?[Ll]ight$/)
				|| fontName.match(/[_\-\s]Condensed$/)
				)
			{
				
			}
			else
			{
				fontName = fontName.replace(/\s*Regular$/, '')
					//.replace(/\sStd\s.*/, '')
					;
				totalFonts += '<option value="'+fontName+'">'+fontName+'</option>';
				regularFontsCounter++;
			}
			
			allFontsCounter++;
		}
		
		totalFonts += '</select>';
		
		$('span#fontList').html(totalFonts);
		
		$('span#fontList select').on('change', function() {
			if($('#input_name').val()!=''){
				role_name.setFontFamily( this.value );
				canvas.renderAll();
			}
		});
	}
	
    </script>
<object id="fontListSWF" name="fontListSWF" type="application/x-shockwave-flash" data="./test/FontList.swf" width="1" height="1">
</body>
</html>